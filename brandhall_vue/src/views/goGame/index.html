<#define __PACKAGE__="views.goGame" />
<#define __ID__="__PACKAGE__.index" />
<#define _TITLE_="å›´æ£‹" />
<#define __INDEX__="{#LAM.INDEX#}" />
<#define __HOME__="__INDEX__{#LAM.routeRules.index#}" />
<#define __CLASSPATH__="{#LAM.classPath#}" />
<#define __COMPONENTS__="{#LAM.COMPONENTS#}" />
<#define __VIEWS__="{#LAM.VIEWS#}" />
<#define ~/="__VIEWS__/goGame/" />
<#define __IMAGE__="{#LAM.IMAGE#}" />

<#import path="/GoGame.class" root="__CLASSPATH__" />

<#Block:begin id="title" data="{'title':'_TITLE_'}"><#Block:end>


<#Block:begin id="__ID__">
<div class="go-game-container">
    <h1 class="page-title">_TITLE_</h1>
    
    <div class="game-settings">
        <div class="setting-group">
            <label>æ¸¸æˆæ¨¡å¼:</label>
            <select v-model="gameMode" @change="changeGameMode" class="mode-select">
                <option value="human">åŒäººå¯¹æˆ˜</option>
                <option value="ai">äººæœºå¯¹æˆ˜</option>
            </select>
        </div>
        
        <div class="setting-group" v-if="gameMode === 'ai'">
            <label>æ‰§å­é¢œè‰²:</label>
            <select v-model="aiPlayer" @change="changeAIPlayer" class="player-select">
                <option value="2">æ‰§é»‘å…ˆè¡Œï¼ˆAIæ‰§ç™½ï¼‰</option>
                <option value="1">æ‰§ç™½åè¡Œï¼ˆAIæ‰§é»‘ï¼‰</option>
            </select>
        </div>

        <div class="setting-group" v-if="gameMode === 'ai'">
            <label>AIéš¾åº¦:</label>
            <select v-model="aiLevel" @change="changeAILevel" class="level-select">
                <option value="easy">ç®€å•</option>
                <option value="medium">ä¸­ç­‰</option>
                <option value="hard">å›°éš¾</option>
            </select>
        </div>
    </div>
    
    <div class="game-controls">
        <button @click="restartGame" class="btn btn-primary">é‡æ–°å¼€å§‹</button>
        <button @click="passTurn" class="btn btn-secondary">è™šç€ (Pass)</button>
        <button @click="undoMove" class="btn btn-warning">æ‚”æ£‹</button>
        <select v-model="boardSize" @change="changeBoardSize" class="board-size-select">
            <option value="9">9è·¯æ£‹ç›˜</option>
            <option value="13">13è·¯æ£‹ç›˜</option>
            <option value="19">19è·¯æ£‹ç›˜</option>
        </select>
        <button @click="toggleDebug" class="btn btn-info" v-if="showDebugBtn">è°ƒè¯•</button>
    </div>
    
    
    <div class="game-info">
        <div class="player-info" :class="{ active: currentPlayer === 1 }">
            <span class="stone black"></span>
            <span>é»‘æ£‹</span>
            <span class="capture-count">æå­: {{ capturedStones.black }}</span>
            <span class="ai-label" v-if="gameMode === 'ai' && aiPlayer === 1">ğŸ¤–</span>
        </div>
        <div class="game-status">{{ gameStatus }}</div>
        <div class="player-info" :class="{ active: currentPlayer === 2 }">
            <span class="stone white"></span>
            <span>ç™½æ£‹</span>
            <span class="capture-count">æå­: {{ capturedStones.white }}</span>
            <span class="ai-label" v-if="gameMode === 'ai' && aiPlayer === 2">ğŸ¤–</span>
        </div>
    </div>
    
    <div class="board-container">
        <canvas ref="goBoard" width="600" height="600" @click="handleBoardClick" @touchstart="handleTouchStart"
        @touchmove="handleTouchMove"
        @touchend="handleTouchEnd"></canvas>
        <div class="ai-thinking" v-if="isAIThinking">AIæ€è€ƒä¸­...</div>
    </div>

    <div class="game-instruction">
        <h3>æ¸¸æˆè¯´æ˜</h3>
        <p v-if="gameMode === 'human'">åŒäººå¯¹æˆ˜æ¨¡å¼ï¼šä¸¤ä½ç©å®¶è½®æµåœ¨æ£‹ç›˜äº¤å‰ç‚¹è½å­</p>
        <p v-if="gameMode === 'ai'">äººæœºå¯¹æˆ˜æ¨¡å¼ï¼šæ‚¨ä¸AIå¯¹æˆ˜ï¼ŒAIä¼šæ ‡è®°ä¸ºğŸ¤–</p>
        <p>æ£‹å­å¿…é¡»æœ‰"æ°”"ï¼ˆç›¸é‚»çš„ç©ºç‚¹ï¼‰ï¼Œæ²¡æœ‰æ°”çš„æ£‹å­ä¼šè¢«ææ‰ã€‚ç¦æ­¢è‡ªæ€ç€æ³•ã€‚</p>
    </div>
</div>
<#Block:end>


<script type="text/javascript">
    LAM.run(function() {
        'use strict';
        var System = this;

        var GoGame = System.require("lam.GoGame");
        

        var ContentComponent = {
            'name': "goGameComponent",
            components: {},
            data(){
                return {
                    boardSize: 19,
                    gameMode: 'human', // 'human' æˆ– 'ai'
                    aiPlayer: 2, // AIæ‰§ç™½
                    currentPlayer: 1,
                    gameOver: false,
                    capturedStones: { black: 0, white: 0 },
                    gameStatus: "é»‘æ£‹å›åˆ",
                    moveCount: 0,
                    goGame: null,
                    isAIThinking: false,
                    aiLevel: 'medium',
                    showDebugBtn: false
                };
            },
            created(){
                this.$emit('change_crumb_data', [
                    { 'name': 'é¦–é¡µ' },
                    { 'name': '_TITLE_' }
                ]);
            },
            mounted(){
                this.initGame();
            },
            methods: {
                changeAILevel() {
                    if (this.goGame) {
                        this.goGame.setAILevel(this.aiLevel);
                    }
                },
                handleTouchStart(event) {
                    event.preventDefault();
                    const touch = event.touches[0];
                    this.touchStart = {
                        x: touch.clientX,
                        y: touch.clientY,
                        time: Date.now()
                    };
                },
                
                handleTouchMove(event) {
                    event.preventDefault();
                },
                
                handleTouchEnd(event) {
                    event.preventDefault();
                    
                    if (!this.touchStart) return;
                    
                    const touch = event.changedTouches[0];
                    const endTime = Date.now();
                    const duration = endTime - this.touchStart.time;
                    
                    const dx = touch.clientX - this.touchStart.x;
                    const dy = touch.clientY - this.touchStart.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // åˆ¤æ–­ä¸ºç‚¹å‡»ï¼ˆä¸æ˜¯æ»‘åŠ¨ï¼‰
                    if (duration < 500 && distance < 30) {
                        console.log("è§¦æ‘¸ç‚¹å‡»ï¼Œè°ƒç”¨handleBoardClick");
                        // ç›´æ¥è°ƒç”¨handleBoardClick
                        this.handleBoardClick(touch.clientX, touch.clientY);
                    }
                    
                    this.touchStart = null;
                },
                initGame() {
                    let self = this;
                    GoGame.showMessage=function(message){
                        self.$notify({
                                title: 'Warning',
                                    message: message,
                                    type: 'warning'});
                    };

                    if (this.goGame) {
                        this.goGame.destructor();
                    }
                    
                    try {
                        // åˆ›å»ºå›´æ£‹æ¸¸æˆå®ä¾‹
                        this.goGame = new GoGame(this.$refs.goBoard, this.boardSize);
                        
                        
                        // è®¾ç½®æ¸¸æˆæ¨¡å¼
                        this.goGame.setGameMode(this.gameMode);
                        this.goGame.setAIPlayer(parseInt(this.aiPlayer));
                        
                        // ç»‘å®šäº‹ä»¶
                        this.goGame.bindEvents();
                        
                        this.updateGameState();
                        console.log("å›´æ£‹æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼Œæ¨¡å¼:", this.gameMode);
                        
                        // å¦‚æœæ˜¯AIæ¨¡å¼ä¸”AIå…ˆæ‰‹ï¼Œè§¦å‘AIæ€è€ƒ
                        if (this.gameMode === 'ai' && this.aiPlayer === 1) {
                            this.isAIThinking = true;
                            System.wait(() => {
                                this.goGame.aiMove();
                                this.isAIThinking = false;
                                this.updateGameState();
                            }, 1000);
                        }
                        
                    } catch (error) {
                        console.error("å›´æ£‹æ¸¸æˆåˆå§‹åŒ–å¤±è´¥:", error);
                        this.showMessage("æ¸¸æˆåˆå§‹åŒ–å¤±è´¥");
                    }
                },
                
                handleBoardClick(event) {
                    if (!this.goGame) return;
                    
                    if (this.gameMode === 'ai' && this.currentPlayer === this.aiPlayer) {
                        this.showMessage("è¯·ç­‰å¾…AIè½å­");
                        return;
                    }
                    
                    // æ¸¸æˆå®ä¾‹ä¼šè‡ªå·±å¤„ç†ç‚¹å‡»äº‹ä»¶
                    // æˆ‘ä»¬åªéœ€è¦æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                    System.wait(() => {
                        this.updateGameState();
                    }, 10);
                },
                
                updateGameState() {
                    if (!this.goGame) return;
                    
                    const state = this.goGame.getGameState();
                    this.currentPlayer = state.currentPlayer;
                    this.gameOver = state.gameOver;
                    this.capturedStones = { ...state.capturedStones };
                    this.moveCount = state.moveCount || 0;
                    
                    this.updateGameStatus();
                },
                
                updateGameStatus() {
                    if (this.gameOver) {
                        this.gameStatus = "æ¸¸æˆç»“æŸ";
                    } else {
                        const playerText = this.currentPlayer === 1 ? "é»‘æ£‹" : "ç™½æ£‹";
                        const modeText = this.gameMode === 'ai' && this.currentPlayer === this.aiPlayer ? "AI" : "ç©å®¶";
                        this.gameStatus = `${playerText}å›åˆ (${modeText})`;
                        
                    }
                },
                
                restartGame() {
                    if (this.goGame) {
                        this.goGame.restart();
                        this.updateGameState();
                        
                        // é‡æ–°è®¾ç½®æ¸¸æˆæ¨¡å¼
                        this.goGame.setGameMode(this.gameMode);
                        this.goGame.setAIPlayer(parseInt(this.aiPlayer));
                        
                        // å¦‚æœæ˜¯AIæ¨¡å¼ä¸”AIå…ˆæ‰‹ï¼Œè§¦å‘AIæ€è€ƒ
                        if (this.gameMode === 'ai' && this.aiPlayer === 1) {
                            this.isAIThinking = true;
                            System.wait(() => {
                                this.goGame.aiMove();
                                this.isAIThinking = false;
                                this.updateGameState();
                            }, 1000);
                        }
                    }
                },
                
                passTurn() {
                    if (this.goGame) {
                        this.goGame.pass();
                        this.updateGameState();
                    }
                },
                
                undoMove() {
                    if (this.goGame) {
                        this.goGame.undo();
                        this.updateGameState();
                    }
                },
                
                changeBoardSize() {
                    this.initGame();
                },
                
                changeGameMode() {
                    this.initGame();
                },
                
                changeAIPlayer() {
                    this.initGame();
                },
                
                toggleDebug() {
                    this.showDebugBtn = !this.showDebugBtn;
                },
                
                showMessage(message) {
                    alert(message);
                }
            },
            
            watch: {
                boardSize() {
                    this.initGame();
                }
            },
            
            beforeDestroy() {
                if (this.goGame) {
                    this.goGame.destructor();
                }
            },
            
            template: `<#=block id="__ID__" />`
        };

        System.export('__ID__', ContentComponent);
    });
</script>

<style type="text/css">
.go-game-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.page-title {
    font-size: 36px;
    text-align: center;
    color: #333;
    margin-bottom: 20px;
}

.game-settings {
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    flex-wrap: wrap;
}

.setting-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.setting-group label {
    font-weight: bold;
    color: #333;
}

.mode-select, .player-select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
}

.game-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.btn-primary { background: #007bff; color: white; }
.btn-secondary { background: #6c757d; color: white; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-info { background: #17a2b8; color: white; }

.board-size-select {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background: white;
}

.game-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.player-info {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 15px;
    border-radius: 5px;
    transition: all 0.3s ease;
    position: relative;
}

.player-info.active {
    background: #e3f2fd;
    border: 2px solid #2196f3;
}

.stone {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    border: 1px solid #666;
}

.stone.black { background: #000; }
.stone.white { background: #fff; }

.capture-count {
    font-weight: bold;
    color: #dc3545;
}

.ai-label {
    font-size: 18px;
    margin-left: 5px;
}

.game-status {
    font-size: 18px;
    font-weight: bold;
    text-align: center;
}

.board-container {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
    position: relative;
}

canvas {
    border: 2px solid #8B4513;
    background: #DCB35C;
    cursor: pointer;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.ai-thinking {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 16px;
    z-index: 10;
}

.game-instruction {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

.game-instruction h3 {
    margin: 0 0 10px 0;
    color: #333;
}

.game-instruction p {
    margin: 5px 0;
    color: #666;
    line-height: 1.5;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .game-settings {
        flex-direction: column;
        align-items: center;
    }
    
    .game-controls {
        flex-direction: column;
        align-items: center;
    }
    
    .game-controls .btn,
    .board-size-select {
        width: 100%;
        max-width: 200px;
    }
    
    .game-info {
        flex-direction: column;
        gap: 10px;
    }
    
    canvas {
        width: 100%;
        height: auto;
        max-width: 400px;
    }
}
</style>